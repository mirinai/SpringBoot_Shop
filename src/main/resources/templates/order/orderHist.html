<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">
<head>
  <!-- CSRF ë³´í˜¸ë¥¼ ìœ„í•œ í† í° ì¶”ê°€ -->
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>
<th:block layout:fragment="script">
  <script>
    // ğŸ“ [ì£¼ë¬¸ ì·¨ì†Œ ìš”ì²­ì„ ë¹„ë™ê¸°ì ìœ¼ë¡œ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜]
    // - ì£¼ë¬¸ ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.
    // - Ajax ìš”ì²­ì„ í†µí•´ ë¹„ë™ê¸°ì ìœ¼ë¡œ ì„œë²„ì— POST ìš”ì²­ì„ ë³´ë‚´ ì£¼ë¬¸ì„ ì·¨ì†Œí•©ë‹ˆë‹¤.
    function cancelOrder(orderId) {
      // CSRF í† í° ê°’ê³¼ í—¤ë” ì´ë¦„ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
      // CSRF ë³´ì•ˆ ê¸°ëŠ¥ì„ í™œì„±í™”í–ˆì„ ê²½ìš°, ìš”ì²­ í—¤ë”ì— CSRF í† í°ì„ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤.
      var token = $("meta[name='_csrf']").attr("content"); // CSRF í† í° ê°’
      var header = $("meta[name='_csrf_header']").attr("content"); // CSRF í—¤ë” ì´ë¦„

      // ì£¼ë¬¸ ì·¨ì†Œ ìš”ì²­ì„ ë³´ë‚¼ URL ë° ë°ì´í„° ì„¤ì •
      var url = "/order/" + orderId + "/cancel"; // ì£¼ë¬¸ ì·¨ì†Œ API URL
      var paramData = {
        orderId: orderId, // ì£¼ë¬¸ IDë¥¼ JSON ë°ì´í„°ë¡œ í¬í•¨
      };

      // JSON ë¬¸ìì—´ë¡œ ë³€í™˜ (ì„œë²„ë¡œ ë³´ë‚¼ ë°ì´í„°)
      var param = JSON.stringify(paramData);

      // Ajax ìš”ì²­
      $.ajax({
        url: url, // ìš”ì²­ì„ ë³´ë‚¼ URL
        type: "POST", // HTTP ë©”ì„œë“œ: POST (ë°ì´í„° ë³€ê²½ ìš”ì²­)
        contentType: "application/json", // ìš”ì²­ ë³¸ë¬¸ì˜ íƒ€ì…ì„ JSONìœ¼ë¡œ ì„¤ì •
        data: param, // ì „ì†¡í•  ë°ì´í„° (JSON ë¬¸ìì—´)
        beforeSend: function (xhr) {
          // ìš”ì²­ì„ ë³´ë‚´ê¸° ì „ì— í—¤ë”ì— CSRF í† í°ì„ ì„¤ì •
          xhr.setRequestHeader(header, token); // "X-CSRF-TOKEN: [token]" í˜•íƒœë¡œ í—¤ë” ì¶”ê°€
        },
        dataType: "json", // ì‘ë‹µ ë°ì´í„°ë¥¼ JSON í˜•ì‹ìœ¼ë¡œ ë°›ì„ ê²ƒì„ ì§€ì •
        cache: false, // ë¸Œë¼ìš°ì € ìºì‹œ ì‚¬ìš© ì•ˆ í•¨
        success: function (result, status) {
          // ìš”ì²­ì´ ì„±ê³µí–ˆì„ ê²½ìš° í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
          alert("ì£¼ë¬¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."); // ì„±ê³µ ë©”ì‹œì§€ ì¶œë ¥
          location.href = "/orders/" + [[${page}]]; // ì£¼ë¬¸ ë‚´ì—­ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
        },
        error: function (jqXHR, status, error) {
          // ìš”ì²­ì´ ì‹¤íŒ¨í–ˆì„ ê²½ìš° í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
          if (jqXHR.status == "401") {
            // 401 Unauthorized ì‘ë‹µì¼ ê²½ìš° (ë¡œê·¸ì¸ë˜ì§€ ì•Šì€ ì‚¬ìš©ì)
            alert("ë¡œê·¸ì¸ ë’¤ ì´ìš©í•´ì£¼ì„¸ìš”"); // ë¡œê·¸ì¸ ìš”ì²­ ë©”ì‹œì§€ ì¶œë ¥
            location.href = "/members/login"; // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
          } else {
            // ê¸°íƒ€ ì˜¤ë¥˜ ë°œìƒ ì‹œ ì„œë²„ ì‘ë‹µ ë©”ì‹œì§€ë¥¼ ì•Œë¦¼ì°½ì— ì¶œë ¥
            alert(jqXHR.responseText);
          }
        },
      });
    }
  </script>
</th:block>

<!-- ì‚¬ìš©ì CSS ì¶”ê°€ -->
<th:block layout:fragment="css">
  <style>
    /* í˜ì´ì§€ ë ˆì´ì•„ì›ƒ ìŠ¤íƒ€ì¼ ì„¤ì • */
    .content-mg {
        margin-left: 30%;
        margin-right: 30%;
        margin-top: 2%;
        margin-bottom: 100px;
    }
    .repImgDiv {
        margin-right: 15px;
        margin-left: 15px;
        height: auto;
    }
    .repImg {
        height: 100px;
        width: 100px;
    }
    .card {
        width: 750px;
        height: 100%;
        padding: 30px;
        margin-bottom: 20px;
    }
    .fs18 {
        font-size: 18px;
    }
    .fs24 {
        font-size: 24px;
    }
  </style>
</th:block>

<!-- ì£¼ë¬¸ ë‚´ì—­ í˜ì´ì§€ ì½˜í…ì¸  ì˜ì—­ -->
<div layout:fragment="content" class="content-mg">

  <!-- êµ¬ë§¤ ì´ë ¥ ì œëª© -->
  <h2 class="mb-4">êµ¬ë§¤ ì´ë ¥</h2>

  <!-- ì£¼ë¬¸ ë‚´ì—­ ë¦¬ìŠ¤íŠ¸ ì¶œë ¥ -->
  <div th:each="order : ${orders.getContent()}">
    <!-- ì£¼ë¬¸ ë‚ ì§œì™€ ì£¼ë¬¸ ìƒíƒœ í‘œì‹œ -->
    <div class="d-flex mb-3 align-self-center">
      <h4 th:text="${order.orderDate} + ' ì£¼ë¬¸'"></h4>
      <div class="ml-3">
        <!-- ì£¼ë¬¸ ìƒíƒœê°€ ORDER(ì£¼ë¬¸ ì™„ë£Œ)ì¸ ê²½ìš° ì·¨ì†Œ ë²„íŠ¼ í‘œì‹œ -->
        <th:block th:if="${order.orderStatus == T(com.shop.constant.OrderStatus).ORDER}">
          <button type="button" class="btn btn-outline-secondary" th:value="${order.orderId}" onclick="cancelOrder(this.value)">ì£¼ë¬¸ì·¨ì†Œ</button>
        </th:block>
        <!-- ì£¼ë¬¸ ìƒíƒœê°€ CANCEL(ì·¨ì†Œëœ ì£¼ë¬¸)ì¸ ê²½ìš° "ì·¨ì†Œ ì™„ë£Œ" í…ìŠ¤íŠ¸ í‘œì‹œ -->
        <th:block th:unless="${order.orderStatus == T(com.shop.constant.OrderStatus).ORDER}">
          <h4>(ì·¨ì†Œ ì™„ë£Œ)</h4>
        </th:block>
      </div>
    </div>

    <!-- ì£¼ë¬¸ í•­ëª© ì¹´ë“œ -->
    <div class="card d-flex">
      <div th:each="orderItem : ${order.orderItemDtoList}" class="d-flex mb-3">
        <!-- ìƒí’ˆ ì´ë¯¸ì§€ -->
        <div class="repImgDiv">
          <img th:src="${orderItem.imgUrl}" class="rounded repImg" th:alt="${orderItem.itemNm}">
        </div>
        <!-- ìƒí’ˆ ì •ë³´ -->
        <div class="align-self-center w-75">
          <span th:text="${orderItem.itemNm}" class="fs24 font-weight-bold"></span>
          <div class="fs18 font-weight-light">
            <!-- ìƒí’ˆ ê°€ê²© -->
            <span th:text="${orderItem.orderPrice} +'ì›'"></span>
            <!-- ì£¼ë¬¸ ìˆ˜ëŸ‰ -->
            <span th:text="${orderItem.count} +'ê°œ'"></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
  <div th:with="start=${(orders.number/maxPage)*maxPage + 1},
  end=(${(orders.totalPages == 0) ? 1 : (start + (maxPage - 1) < orders.totalPages ? start + (maxPage - 1) : orders.totalPages)})">
    <ul class="pagination justify-content-center">
      <!-- ì´ì „ í˜ì´ì§€ ë²„íŠ¼ -->
      <li class="page-item" th:classappend="${orders.number eq 0}?'disabled':''">
        <a th:href="@{'/orders/' + ${orders.number-1}}" aria-label='Previous' class="page-link">
          <span aria-hidden='true'>Previous</span>
        </a>
      </li>

      <!-- í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼ -->
      <li class="page-item" th:each="page: ${#numbers.sequence(start, end)}" th:classappend="${orders.number eq page-1}?'active':''">
        <a th:href="@{'/orders/' + ${page-1}}" th:inline="text" class="page-link">[[${page}]]</a>
      </li>

      <!-- ë‹¤ìŒ í˜ì´ì§€ ë²„íŠ¼ -->
      <li class="page-item" th:classappend="${orders.number+1 ge orders.totalPages}?'disabled':''">
        <a th:href="@{'/orders/' + ${orders.number+1}}" aria-label='Next' class="page-link">
          <span aria-hidden='true'>Next</span>
        </a>
      </li>
    </ul>
  </div>

</div>
</html>
